import{TokenError as t}from"./error.js";import{createSign as e,createHmac as r,timingSafeEqual as i,createVerify as n,constants as o,sign as a,verify as s}from"crypto";import{derToJose as u,joseToDer as h}from"ecdsa-sig-formatter";function f(t){Object.defineProperty(this,"_next",{writable:!1,enumerable:!1,value:t}),this.done=!1}f.prototype.next=function(){if(this.done)return{done:!0};var t=this._next();return t.done&&(this.done=!0),t},"undefined"!=typeof Symbol&&(f.prototype[Symbol.iterator]=function(){return this}),f.of=function(){var t=arguments,e=t.length,r=0;return new f((function(){return r>=e?{done:!0}:{done:!1,value:t[r++]}}))},f.empty=function(){var t=new f(null);return t.done=!0,t},f.is=function(t){return t instanceof f||"object"==typeof t&&null!==t&&"function"==typeof t.next};var c=f,l="undefined"!=typeof ArrayBuffer,y="undefined"!=typeof Symbol;function p(t,e){var r,i,n,o,a;if(!t)throw new Error("obliterator/forEach: invalid iterable.");if("function"!=typeof e)throw new Error("obliterator/forEach: expecting a callback.");if(Array.isArray(t)||l&&ArrayBuffer.isView(t)||"string"==typeof t||"[object Arguments]"===t.toString())for(n=0,o=t.length;n<o;n++)e(t[n],n);else if("function"!=typeof t.forEach)if(y&&Symbol.iterator in t&&"function"!=typeof t.next&&(t=t[Symbol.iterator]()),"function"!=typeof t.next)for(i in t)t.hasOwnProperty(i)&&e(t[i],i);else for(r=t,n=0;!0!==(a=r.next()).done;)e(a.value,n),n++;else t.forEach(e)}p.forEachWithNullKeys=function(t,e){var r,i,n,o,a;if(!t)throw new Error("obliterator/forEachWithNullKeys: invalid iterable.");if("function"!=typeof e)throw new Error("obliterator/forEachWithNullKeys: expecting a callback.");if(Array.isArray(t)||l&&ArrayBuffer.isView(t)||"string"==typeof t||"[object Arguments]"===t.toString())for(n=0,o=t.length;n<o;n++)e(t[n],null);else if(t instanceof Set)t.forEach((function(t){e(t,null)}));else if("function"!=typeof t.forEach)if(y&&Symbol.iterator in t&&"function"!=typeof t.next&&(t=t[Symbol.iterator]()),"function"!=typeof t.next)for(i in t)t.hasOwnProperty(i)&&e(t[i],i);else for(r=t,n=0;!0!==(a=r.next()).done;)e(a.value,null),n++;else t.forEach(e)};var d=p;var w,v,m=(function(t,e){var r=Math.pow(2,8)-1,i=Math.pow(2,16)-1,n=Math.pow(2,32)-1,o=Math.pow(2,7)-1,a=Math.pow(2,15)-1,s=Math.pow(2,31)-1;e.getPointerArray=function(t){var e=t-1;return e<=r?Uint8Array:e<=i?Uint16Array:e<=n?Uint32Array:Float64Array},e.getSignedPointerArray=function(t){var e=t-1;return e<=o?Int8Array:e<=a?Int16Array:e<=s?Int32Array:Float64Array},e.getNumberType=function(t){return t===(0|t)?-1===Math.sign(t)?t<=127&&t>=-128?Int8Array:t<=32767&&t>=-32768?Int16Array:Int32Array:t<=255?Uint8Array:t<=65535?Uint16Array:Uint32Array:Float64Array};var u={Uint8Array:1,Int8Array:2,Uint16Array:3,Int16Array:4,Uint32Array:5,Int32Array:6,Float32Array:7,Float64Array:8};e.getMinimalRepresentation=function(t,r){var i,n,o,a,s,h=null,f=0;for(a=0,s=t.length;a<s;a++)o=r?r(t[a]):t[a],n=e.getNumberType(o),(i=u[n.name])>f&&(f=i,h=n);return h},e.isTypedArray=function(t){return"undefined"!=typeof ArrayBuffer&&ArrayBuffer.isView(t)},e.concat=function(){var t,e,r,i=0;for(t=0,r=arguments.length;t<r;t++)i+=arguments[t].length;var n=new arguments[0].constructor(i);for(t=0,e=0;t<r;t++)n.set(arguments[t],e),e+=arguments[t].length;return n},e.indices=function(t){for(var r=new(e.getPointerArray(t))(t),i=0;i<t;i++)r[i]=i;return r}}(v={path:w,exports:{},require:function(t,e){return function(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}(null==e&&v.path)}},v.exports),v.exports),b=m.isTypedArray;function g(t){return"number"==typeof t.length?t.length:"number"==typeof t.size?t.size:void 0}var S={isArrayLike:function(t){return Array.isArray(t)||b(t)},guessLength:g,toArray:function(t){var e=g(t),r="number"==typeof e?new Array(e):[],i=0;return d(t,(function(t){r[i++]=t})),r}};function A(t,e,r){if(arguments.length<2&&(r=t,t=null,e=null),this.capacity=r,"number"!=typeof this.capacity||this.capacity<=0)throw new Error("mnemonist/lru-cache: capacity should be positive number.");var i=m.getPointerArray(r);this.forward=new i(r),this.backward=new i(r),this.K="function"==typeof t?new t(r):new Array(r),this.V="function"==typeof e?new e(r):new Array(r),this.size=0,this.head=0,this.tail=0,this.items={}}A.prototype.clear=function(){this.size=0,this.head=0,this.tail=0,this.items={}},A.prototype.splayOnTop=function(t){var e=this.head;if(this.head===t)return this;var r=this.backward[t],i=this.forward[t];return this.tail===t?this.tail=r:this.backward[i]=r,this.forward[r]=i,this.backward[e]=t,this.head=t,this.forward[t]=e,this},A.prototype.set=function(t,e){var r=this.items[t];if(void 0!==r)return this.splayOnTop(r),void(this.V[r]=e);this.size<this.capacity?r=this.size++:(r=this.tail,this.tail=this.backward[r],delete this.items[this.K[r]]),this.items[t]=r,this.K[r]=t,this.V[r]=e,this.forward[r]=this.head,this.backward[this.head]=r,this.head=r},A.prototype.setpop=function(t,e){var r=null,i=null,n=this.items[t];return void 0!==n?(this.splayOnTop(n),r=this.V[n],this.V[n]=e,{evicted:!1,key:t,value:r}):(this.size<this.capacity?n=this.size++:(n=this.tail,this.tail=this.backward[n],r=this.V[n],i=this.K[n],delete this.items[this.K[n]]),this.items[t]=n,this.K[n]=t,this.V[n]=e,this.forward[n]=this.head,this.backward[this.head]=n,this.head=n,i?{evicted:!0,key:i,value:r}:null)},A.prototype.has=function(t){return t in this.items},A.prototype.get=function(t){var e=this.items[t];if(void 0!==e)return this.splayOnTop(e),this.V[e]},A.prototype.peek=function(t){var e=this.items[t];if(void 0!==e)return this.V[e]},A.prototype.forEach=function(t,e){e=arguments.length>1?e:this;for(var r=0,i=this.size,n=this.head,o=this.K,a=this.V,s=this.forward;r<i;)t.call(e,a[n],o[n],this),n=s[n],r++},A.prototype.keys=function(){var t=0,e=this.size,r=this.head,i=this.K,n=this.forward;return new c((function(){if(t>=e)return{done:!0};var o=i[r];return++t<e&&(r=n[r]),{done:!1,value:o}}))},A.prototype.values=function(){var t=0,e=this.size,r=this.head,i=this.V,n=this.forward;return new c((function(){if(t>=e)return{done:!0};var o=i[r];return++t<e&&(r=n[r]),{done:!1,value:o}}))},A.prototype.entries=function(){var t=0,e=this.size,r=this.head,i=this.K,n=this.V,o=this.forward;return new c((function(){if(t>=e)return{done:!0};var a=i[r],s=n[r];return++t<e&&(r=o[r]),{done:!1,value:[a,s]}}))},"undefined"!=typeof Symbol&&(A.prototype[Symbol.iterator]=A.prototype.entries),A.prototype.inspect=function(){for(var t,e=new Map,r=this.entries();!(t=r.next()).done;)e.set(t.value[0],t.value[1]);return Object.defineProperty(e,"constructor",{value:A,enumerable:!1}),e},"undefined"!=typeof Symbol&&(A.prototype[Symbol.for("nodejs.util.inspect.custom")]=A.prototype.inspect),A.from=function(t,e,r,i){if(arguments.length<2){if("number"!=typeof(i=S.guessLength(t)))throw new Error("mnemonist/lru-cache.from: could not guess iterable length. Please provide desired capacity as last argument.")}else 2===arguments.length&&(i=e,e=null,r=null);var n=new A(e,r,i);return d(t,(function(t,e){n.set(e,t)})),n};var E=A;const k=require("asn1.js").define,{RSA_PKCS1_PSS_PADDING:P,RSA_PSS_SALTLEN_DIGEST:K,RSA_PKCS1_PADDING:j,RSA_PSS_SALTLEN_MAX_SIGN:I,RSA_PSS_SALTLEN_AUTO:U}=o;let x=a;const R=s,T="function"==typeof x,V=/[=+/]/g,_={"=":"","+":"-","/":"_"},B=/^-----BEGIN(?: (RSA|EC))? PRIVATE KEY-----/,C=new E(1e3),L=new E(1e3),N=["HS256","HS384","HS512"],M=["ES256","ES384","ES512"],D=["RS256","RS384","RS512","PS256","PS384","PS512"],z=["EdDSA"],O={"1.2.840.10045.3.1.7":{bits:"256",names:["P-256","prime256v1"]},"1.3.132.0.10":{bits:"256",names:["secp256k1"]},"1.3.132.0.34":{bits:"384",names:["P-384","secp384r1"]},"1.3.132.0.35":{bits:"512",names:["P-521","secp521r1"]}};T||(x=function(r,i,n){if(void 0===r)throw new t(t.codes.signError,"EdDSA algorithms are not supported by your Node.js version.");return e(r).update(i).sign(n)});const q=k("PrivateKey",(function(){this.seq().obj(this.key("version").int(),this.key("algorithm").seq().obj(this.key("algorithm").objid(),this.key("parameters").optional().objid()))})),G=k("PublicKey",(function(){this.seq().obj(this.key("algorithm").seq().obj(this.key("algorithm").objid(),this.key("parameters").optional().objid()))})),H=k("ECPrivateKey",(function(){this.seq().obj(this.key("version").int(),this.key("privateKey").octstr(),this.key("parameters").explicit(0).optional().choice({namedCurve:this.objid()}))}));function Y(t){return _[t]}function F(t,e,r,i){return t.set(e,[r,i]),r||i}function $(e){if(e instanceof Buffer)e=e.toString("utf-8");else if("string"!=typeof e)throw new t(t.codes.invalidKey,"The private key must be a string or a buffer.");const[r,i]=C.get(e)||[];if(r)return r;if(i)throw i;try{return F(C,e,function(e){if(e.includes("-----BEGIN PUBLIC KEY-----"))throw new t(t.codes.invalidKey,"Public keys are not supported for signing.");const r=e.trim().match(B);if(!r)return"HS256";let i,n,o;switch(r[1]){case"RSA":return"RS256";case"EC":i=H.decode(e,"pem",{label:"EC PRIVATE KEY"}),o=i.parameters.value.join(".");break;default:switch(i=q.decode(e,"pem",{label:"PRIVATE KEY"}),n=i.algorithm.algorithm.join("."),n){case"1.2.840.113549.1.1.1":return"RS256";case"1.2.840.10045.2.1":o=i.algorithm.parameters.join(".");break;case"1.3.101.112":case"1.3.101.113":return"EdDSA";default:throw new t(t.codes.invalidKey,`Unsupported PEM PCKS8 private key with OID ${n}.`)}}const a=O[o];if(!a)throw new t(t.codes.invalidKey,`Unsupported EC private key with curve ${o}.`);return"ES"+a.bits}(e))}catch(r){throw F(C,e,null,t.wrap(r,t.codes.invalidKey,"Unsupported PEM private key."))}}function W(e){if(!e)return"none";const[r,i]=L.get(e)||[];if(r)return r;if(i)throw i;try{if(e instanceof Buffer)e=e.toString("utf-8");else if("string"!=typeof e)throw new t(t.codes.invalidKey,"The public key must be a string or a buffer.");return F(L,e,function(e){if(e.match(B))throw new t(t.codes.invalidKey,"Private keys are not supported for verifying.");if(!e.includes("-----BEGIN PUBLIC KEY-----"))return N;const r=G.decode(e,"pem",{label:"PUBLIC KEY"}),i=r.algorithm.algorithm.join(".");let n;switch(i){case"1.2.840.113549.1.1.1":return D;case"1.2.840.10045.2.1":n=r.algorithm.parameters.join(".");break;case"1.3.101.112":case"1.3.101.113":return["EdDSA"];default:throw new t(t.codes.invalidKey,`Unsupported PEM PCKS8 public key with OID ${i}.`)}const o=O[n];if(!o)throw new t(t.codes.invalidKey,`Unsupported EC public key with curve ${n}.`);return["ES"+o.bits]}(e))}catch(r){throw F(L,e,null,t.wrap(r,t.codes.invalidKey,"Unsupported PEM public key."))}}function X(i,n,o){try{const t=i.slice(0,2),a="sha"+i.slice(2);let s,h;switch(t){case"HS":s=r(a,n).update(o).digest("base64");break;case"ES":s=u(x(a,Buffer.from(o,"utf-8"),n),i).toString("base64");break;case"RS":case"PS":h={key:n,padding:j,saltLength:I},"PS"===t&&(h.padding=P,h.saltLength=K),s=e(a).update(o).sign(h).toString("base64");break;case"Ed":s=x(void 0,Buffer.from(o,"utf-8"),n).toString("base64")}return s.replace(V,Y)}catch(e){throw new t(t.codes.signError,"Cannot create the signature.",{originalError:e})}}function J(e,o,a,s){try{const u=e.slice(0,2),f="SHA"+e.slice(2);if(s=Buffer.from(s,"base64"),"HS"===u)try{return i(r(f,o).update(a).digest(),s)}catch(t){return!1}else if("Ed"===u){if("function"==typeof R)return R(void 0,Buffer.from(a,"utf-8"),o,s);throw new t(t.codes.signError,"EdDSA algorithms are not supported by your Node.js version.")}const c={key:o,padding:j,saltLength:U};return"PS"===u?(c.padding=P,c.saltLength=K):"ES"===u&&(s=h(s,e)),n("RSA-"+f).update(a).verify(c,s)}catch(e){throw new t(t.codes.verifyError,"Cannot verify the signature.",{originalError:e})}}export{z as a,$ as b,V as c,W as d,M as e,Y as f,X as g,N as h,E as l,D as r,T as u,J as v};
