Object.defineProperty(exports,"__esModule",{value:!0});var e=require("./error.js"),r=require("./decoder.js"),o=require("crypto"),t=require("./crypto-7c2eb296.js");require("ecdsa-sig-formatter");var n=require("./utils.js");function i(r,o){const t=r[0].slice(0,2),n=o[0].slice(0,2);let i=!0;if("RS"===t||"PS"===t?i="RS"===n:"ES"!==t&&"Ed"!==t||(i=t===n),!i)throw new e.TokenError(e.TokenError.codes.invalidKey,`Invalid public key provided for algorithms ${r.join(", ")}.`)}function a(e,r){return"string"==typeof e&&(e=Buffer.from(e,"utf-8")),t.useNewCrypto&&(e=r?o.createSecretKey(e):o.createPublicKey(e)),e}function c(e){return Array.isArray(e)||(e=[e]),e.map(e=>e&&"function"==typeof e.test?e:new RegExp(e.toString()))}function l(e){const r=parseInt(!0===e?1e3:e,10);return r>0?new t.lruCache(r):null}function s({cache:e,token:r,cacheTTL:o,payload:t,ignoreExpiration:i,ignoreNotBefore:a,maxAge:c,clockTimestamp:l,clockTolerance:s},u){if(!e)return u;const p=[u,0,0];t&&"number"==typeof t.iat&&(p[1]=a||"number"!=typeof t.nbf?0:1e3*t.nbf,i||("number"==typeof t.exp?p[2]=1e3*t.exp:c&&(p[2]=1e3*t.iat+c)));const d=(l||Date.now())+s+o;return p[2]=0===p[2]?d:Math.min(p[2],d),e.set(n.hashToken(r),p),u}function u(r,o,t,n){const i=t?`The ${o} claim must be a ${n} or an array of ${n}s.`:`The ${o} claim must be a ${n}.`;if(r.map(e=>typeof e).some(e=>e!==n))throw new e.TokenError(e.TokenError.codes.invalidClaimType,i)}function p(r,o,t,n){const i=n?`None of ${o} claim values is allowed.`:`The ${o} claim value is not allowed.`;if(!r.some(e=>t.some(r=>r.test(e))))throw new e.TokenError(e.TokenError.codes.invalidClaimValue,i)}function d(r,o,t,n,i,a){const c=1e3*r+(o||0);if(!(n?t>=c:t<=c))throw new e.TokenError(e.TokenError.codes[i],`The token ${a} at ${new Date(c).toISOString()}.`)}function f(r,{input:o,header:n,payload:i,signature:a},{validators:c,allowedAlgorithms:l,checkTyp:s,clockTimestamp:f,clockTolerance:h}){const m=r instanceof Buffer?r.length:!!r;if(m&&!a)throw new e.TokenError(e.TokenError.codes.missingSignature,"The token signature is missing.");if(!m&&a)throw new e.TokenError(e.TokenError.codes.missingKey,"The key option is missing.");if(function(r,o,n,i,a){if(!a.includes(o.alg))throw new e.TokenError(e.TokenError.codes.invalidAlgorithm,"The token algorithm is invalid.");if(n&&!t.verifySignature(o.alg,i,r,n))throw new e.TokenError(e.TokenError.codes.invalidSignature,"The token signature is invalid.")}(o,n,a,r,l),s&&("string"!=typeof n.typ||s!==n.typ.toLowerCase().replace(/^application\//,"")))throw new e.TokenError(e.TokenError.codes.invalidType,"Invalid typ.");const T=(f||Date.now())+h;for(const e of c){const{type:r,claim:o,allowed:t,array:n,modifier:a,greater:c,errorCode:l,errorVerb:s}=e,f=i[o],h=Array.isArray(f),m=h?f:[f];o in i&&(u(m,o,n,"date"===r?"number":"string"),"date"===r?d(f,a,T,c,l,s):p(m,o,t,h))}}function h({key:r,allowedAlgorithms:o,complete:c,cacheTTL:l,checkTyp:u,clockTimestamp:p,clockTolerance:d,ignoreExpiration:h,ignoreNotBefore:m,maxAge:T,isAsync:y,validators:k,decode:g,cache:w},b,E){const[v,A]=y?n.ensurePromiseCallback(E):[],x={cache:w,token:b,cacheTTL:l,payload:void 0,ignoreExpiration:h,ignoreNotBefore:m,maxAge:T,clockTimestamp:p,clockTolerance:d};if(w){const[r,o,t]=w.get(n.hashToken(b))||[void 0,0,0],i=(p||Date.now())+d;if(void 0!==r&&(0===o||i>o)&&(0===t||i<=t))return function(r,o,t){if(r instanceof e.TokenError){if(!o)throw r;o(r)}else{if(!o)return r;o(null,r)}return t}(r,v,A)}let C;try{C=g(b)}catch(e){if(v)return v(e),A;throw e}const{header:S,payload:L,signature:N}=C;x.payload=L;const $={validators:k,allowedAlgorithms:o,checkTyp:u,clockTimestamp:p,clockTolerance:d};if(!v)try{return f(r,C,$),s(x,c?{header:S,payload:L,signature:N}:L)}catch(e){throw s(x,e)}return n.getAsyncKey(r,S,(r,n)=>{if(r)return v(s(x,e.TokenError.wrap(r,e.TokenError.codes.keyFetchingError,"Cannot fetch key.")));if("string"==typeof n)n=Buffer.from(n,"utf-8");else if(!(n instanceof Buffer))return v(s(x,new e.TokenError(e.TokenError.codes.keyFetchingError,"The key returned from the callback must be a string or a buffer containing a secret or a public key.")));try{const e=t.detectPublicKeyAlgorithms(n);$.allowedAlgorithms.length?i(o,e):$.allowedAlgorithms=e,f(n=a(n,e[0]===t.hsAlgorithms[0]),C,$)}catch(e){return v(s(x,e))}v(null,s(x,c?{header:S,payload:L,signature:N}:L))}),A}exports.createVerifier=function(o){let{key:n,algorithms:s,complete:u,cache:p,cacheTTL:d,checkTyp:f,clockTimestamp:m,clockTolerance:T,ignoreExpiration:y,ignoreNotBefore:k,maxAge:g,allowedJti:w,allowedAud:b,allowedIss:E,allowedSub:v,allowedNonce:A}={cacheTTL:6e5,...o};Array.isArray(s)||(s=[]);const x=typeof n;if("string"!==x&&"object"!==x&&"function"!==x)throw new e.TokenError(e.TokenError.codes.INVALID_OPTION,"The key option must be a string, a buffer or a function returning the algorithm secret or public key.");if(n&&"function"!==x){const e=t.detectPublicKeyAlgorithms(n);s.length?i(s,e):s=e,n=a(n,e[0]===t.hsAlgorithms[0])}if(m&&("number"!=typeof m||m<0))throw new e.TokenError(e.TokenError.codes.invalidOption,"The clockTimestamp option must be a positive number.");if(T&&("number"!=typeof T||T<0))throw new e.TokenError(e.TokenError.codes.invalidOption,"The clockTolerance option must be a positive number.");if(T=0,d&&("number"!=typeof d||d<0))throw new e.TokenError(e.TokenError.codes.invalidOption,"The cacheTTL option must be a positive number.");const C=[];k||C.push({type:"date",claim:"nbf",errorCode:"inactive",errorVerb:"will be active",greater:!0}),y||C.push({type:"date",claim:"exp",errorCode:"expired",errorVerb:"has expired"}),"number"==typeof g&&C.push({type:"date",claim:"iat",errorCode:"expired",errorVerb:"has expired",modifier:g}),w&&C.push({type:"string",claim:"jti",allowed:c(w)}),b&&C.push({type:"string",claim:"aud",allowed:c(b),array:!0}),E&&C.push({type:"string",claim:"iss",allowed:c(E)}),v&&C.push({type:"string",claim:"sub",allowed:c(v)}),A&&C.push({type:"string",claim:"nonce",allowed:c(A)});let S=null;f&&(S=f.toLowerCase().replace(/^application\//,""));const L={key:n,allowedAlgorithms:s,complete:u,cacheTTL:d,checkTyp:S,clockTimestamp:m,clockTolerance:T,ignoreExpiration:y,ignoreNotBefore:k,maxAge:g,isAsync:"function"===x,validators:C,decode:r.createDecoder({complete:!0}),cache:l(p)},N=h.bind(null,L);return N.cache=L.cache,N};
