var e=require("./error.js"),r=require("crypto"),t=require("ecdsa-sig-formatter");function n(e){Object.defineProperty(this,"_next",{writable:!1,enumerable:!1,value:e}),this.done=!1}n.prototype.next=function(){if(this.done)return{done:!0};var e=this._next();return e.done&&(this.done=!0),e},"undefined"!=typeof Symbol&&(n.prototype[Symbol.iterator]=function(){return this}),n.of=function(){var e=arguments,r=e.length,t=0;return new n((function(){return t>=r?{done:!0}:{done:!1,value:e[t++]}}))},n.empty=function(){var e=new n(null);return e.done=!0,e},n.is=function(e){return e instanceof n||"object"==typeof e&&null!==e&&"function"==typeof e.next};var i=n,o="undefined"!=typeof ArrayBuffer,a="undefined"!=typeof Symbol;function s(e,r){var t,n,i,s,u;if(!e)throw new Error("obliterator/forEach: invalid iterable.");if("function"!=typeof r)throw new Error("obliterator/forEach: expecting a callback.");if(Array.isArray(e)||o&&ArrayBuffer.isView(e)||"string"==typeof e||"[object Arguments]"===e.toString())for(i=0,s=e.length;i<s;i++)r(e[i],i);else if("function"!=typeof e.forEach)if(a&&Symbol.iterator in e&&"function"!=typeof e.next&&(e=e[Symbol.iterator]()),"function"!=typeof e.next)for(n in e)e.hasOwnProperty(n)&&r(e[n],n);else for(t=e,i=0;!0!==(u=t.next()).done;)r(u.value,i),i++;else e.forEach(r)}s.forEachWithNullKeys=function(e,r){var t,n,i,s,u;if(!e)throw new Error("obliterator/forEachWithNullKeys: invalid iterable.");if("function"!=typeof r)throw new Error("obliterator/forEachWithNullKeys: expecting a callback.");if(Array.isArray(e)||o&&ArrayBuffer.isView(e)||"string"==typeof e||"[object Arguments]"===e.toString())for(i=0,s=e.length;i<s;i++)r(e[i],null);else if(e instanceof Set)e.forEach((function(e){r(e,null)}));else if("function"!=typeof e.forEach)if(a&&Symbol.iterator in e&&"function"!=typeof e.next&&(e=e[Symbol.iterator]()),"function"!=typeof e.next)for(n in e)e.hasOwnProperty(n)&&r(e[n],n);else for(t=e,i=0;!0!==(u=t.next()).done;)r(u.value,null),i++;else e.forEach(r)};var u=s;var h,c,f=(function(e,r){var t=Math.pow(2,8)-1,n=Math.pow(2,16)-1,i=Math.pow(2,32)-1,o=Math.pow(2,7)-1,a=Math.pow(2,15)-1,s=Math.pow(2,31)-1;r.getPointerArray=function(e){var r=e-1;return r<=t?Uint8Array:r<=n?Uint16Array:r<=i?Uint32Array:Float64Array},r.getSignedPointerArray=function(e){var r=e-1;return r<=o?Int8Array:r<=a?Int16Array:r<=s?Int32Array:Float64Array},r.getNumberType=function(e){return e===(0|e)?-1===Math.sign(e)?e<=127&&e>=-128?Int8Array:e<=32767&&e>=-32768?Int16Array:Int32Array:e<=255?Uint8Array:e<=65535?Uint16Array:Uint32Array:Float64Array};var u={Uint8Array:1,Int8Array:2,Uint16Array:3,Int16Array:4,Uint32Array:5,Int32Array:6,Float32Array:7,Float64Array:8};r.getMinimalRepresentation=function(e,t){var n,i,o,a,s,h=null,c=0;for(a=0,s=e.length;a<s;a++)o=t?t(e[a]):e[a],i=r.getNumberType(o),(n=u[i.name])>c&&(c=n,h=i);return h},r.isTypedArray=function(e){return"undefined"!=typeof ArrayBuffer&&ArrayBuffer.isView(e)},r.concat=function(){var e,r,t,n=0;for(e=0,t=arguments.length;e<t;e++)n+=arguments[e].length;var i=new arguments[0].constructor(n);for(e=0,r=0;e<t;e++)i.set(arguments[e],r),r+=arguments[e].length;return i},r.indices=function(e){for(var t=new(r.getPointerArray(e))(e),n=0;n<e;n++)t[n]=n;return t}}(c={path:h,exports:{},require:function(e,r){return function(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}(null==r&&c.path)}},c.exports),c.exports),l=f.isTypedArray;function p(e){return"number"==typeof e.length?e.length:"number"==typeof e.size?e.size:void 0}var y={isArrayLike:function(e){return Array.isArray(e)||l(e)},guessLength:p,toArray:function(e){var r=p(e),t="number"==typeof r?new Array(r):[],n=0;return u(e,(function(e){t[n++]=e})),t}};function d(e,r,t){if(arguments.length<2&&(t=e,e=null,r=null),this.capacity=t,"number"!=typeof this.capacity||this.capacity<=0)throw new Error("mnemonist/lru-cache: capacity should be positive number.");var n=f.getPointerArray(t);this.forward=new n(t),this.backward=new n(t),this.K="function"==typeof e?new e(t):new Array(t),this.V="function"==typeof r?new r(t):new Array(t),this.size=0,this.head=0,this.tail=0,this.items={}}d.prototype.clear=function(){this.size=0,this.head=0,this.tail=0,this.items={}},d.prototype.splayOnTop=function(e){var r=this.head;if(this.head===e)return this;var t=this.backward[e],n=this.forward[e];return this.tail===e?this.tail=t:this.backward[n]=t,this.forward[t]=n,this.backward[r]=e,this.head=e,this.forward[e]=r,this},d.prototype.set=function(e,r){var t=this.items[e];if(void 0!==t)return this.splayOnTop(t),void(this.V[t]=r);this.size<this.capacity?t=this.size++:(t=this.tail,this.tail=this.backward[t],delete this.items[this.K[t]]),this.items[e]=t,this.K[t]=e,this.V[t]=r,this.forward[t]=this.head,this.backward[this.head]=t,this.head=t},d.prototype.setpop=function(e,r){var t=null,n=null,i=this.items[e];return void 0!==i?(this.splayOnTop(i),t=this.V[i],this.V[i]=r,{evicted:!1,key:e,value:t}):(this.size<this.capacity?i=this.size++:(i=this.tail,this.tail=this.backward[i],t=this.V[i],n=this.K[i],delete this.items[this.K[i]]),this.items[e]=i,this.K[i]=e,this.V[i]=r,this.forward[i]=this.head,this.backward[this.head]=i,this.head=i,n?{evicted:!0,key:n,value:t}:null)},d.prototype.has=function(e){return e in this.items},d.prototype.get=function(e){var r=this.items[e];if(void 0!==r)return this.splayOnTop(r),this.V[r]},d.prototype.peek=function(e){var r=this.items[e];if(void 0!==r)return this.V[r]},d.prototype.forEach=function(e,r){r=arguments.length>1?r:this;for(var t=0,n=this.size,i=this.head,o=this.K,a=this.V,s=this.forward;t<n;)e.call(r,a[i],o[i],this),i=s[i],t++},d.prototype.keys=function(){var e=0,r=this.size,t=this.head,n=this.K,o=this.forward;return new i((function(){if(e>=r)return{done:!0};var i=n[t];return++e<r&&(t=o[t]),{done:!1,value:i}}))},d.prototype.values=function(){var e=0,r=this.size,t=this.head,n=this.V,o=this.forward;return new i((function(){if(e>=r)return{done:!0};var i=n[t];return++e<r&&(t=o[t]),{done:!1,value:i}}))},d.prototype.entries=function(){var e=0,r=this.size,t=this.head,n=this.K,o=this.V,a=this.forward;return new i((function(){if(e>=r)return{done:!0};var i=n[t],s=o[t];return++e<r&&(t=a[t]),{done:!1,value:[i,s]}}))},"undefined"!=typeof Symbol&&(d.prototype[Symbol.iterator]=d.prototype.entries),d.prototype.inspect=function(){for(var e,r=new Map,t=this.entries();!(e=t.next()).done;)r.set(e.value[0],e.value[1]);return Object.defineProperty(r,"constructor",{value:d,enumerable:!1}),r},"undefined"!=typeof Symbol&&(d.prototype[Symbol.for("nodejs.util.inspect.custom")]=d.prototype.inspect),d.from=function(e,r,t,n){if(arguments.length<2){if("number"!=typeof(n=y.guessLength(e)))throw new Error("mnemonist/lru-cache.from: could not guess iterable length. Please provide desired capacity as last argument.")}else 2===arguments.length&&(n=r,r=null,t=null);var i=new d(r,t,n);return u(e,(function(e,r){i.set(r,e)})),i};var w=d;const g=require("asn1.js").define,{RSA_PKCS1_PSS_PADDING:v,RSA_PSS_SALTLEN_DIGEST:m,RSA_PKCS1_PADDING:E,RSA_PSS_SALTLEN_MAX_SIGN:b,RSA_PSS_SALTLEN_AUTO:S}=r.constants;let A=r.sign;const k=r.verify,T="function"==typeof A,P=/[=+/]/g,K={"=":"","+":"-","/":"_"},x=/^-----BEGIN(?: (RSA|EC))? PRIVATE KEY-----/,j=new w(1e3),I=new w(1e3),U=["HS256","HS384","HS512"],R=["RS256","RS384","RS512","PS256","PS384","PS512"],V={"1.2.840.10045.3.1.7":{bits:"256",names:["P-256","prime256v1"]},"1.3.132.0.10":{bits:"256",names:["secp256k1"]},"1.3.132.0.34":{bits:"384",names:["P-384","secp384r1"]},"1.3.132.0.35":{bits:"512",names:["P-521","secp521r1"]}};T||(A=function(t,n,i){if(void 0===t)throw new e.TokenError(e.TokenError.codes.signError,"EdDSA algorithms are not supported by your Node.js version.");return r.createSign(t).update(n).sign(i)});const C=g("PrivateKey",(function(){this.seq().obj(this.key("version").int(),this.key("algorithm").seq().obj(this.key("algorithm").objid(),this.key("parameters").optional().objid()))})),_=g("PublicKey",(function(){this.seq().obj(this.key("algorithm").seq().obj(this.key("algorithm").objid(),this.key("parameters").optional().objid()))})),B=g("ECPrivateKey",(function(){this.seq().obj(this.key("version").int(),this.key("privateKey").octstr(),this.key("parameters").explicit(0).optional().choice({namedCurve:this.objid()}))}));function N(e){return K[e]}function L(e,r,t,n){return e.set(r,[t,n]),t||n}exports.base64UrlMatcher=P,exports.base64UrlReplacer=N,exports.createSignature=function(n,i,o){try{const e=n.slice(0,2),a="sha"+n.slice(2);let s,u;switch(e){case"HS":s=r.createHmac(a,i).update(o).digest("base64");break;case"ES":s=t.derToJose(A(a,Buffer.from(o,"utf-8"),i),n).toString("base64");break;case"RS":case"PS":u={key:i,padding:E,saltLength:b},"PS"===e&&(u.padding=v,u.saltLength=m),s=r.createSign(a).update(o).sign(u).toString("base64");break;case"Ed":s=A(void 0,Buffer.from(o,"utf-8"),i).toString("base64")}return s.replace(P,N)}catch(r){throw new e.TokenError(e.TokenError.codes.signError,"Cannot create the signature.",{originalError:r})}},exports.detectPrivateKeyAlgorithm=function(r){if(r instanceof Buffer)r=r.toString("utf-8");else if("string"!=typeof r)throw new e.TokenError(e.TokenError.codes.invalidKey,"The private key must be a string or a buffer.");const[t,n]=j.get(r)||[];if(t)return t;if(n)throw n;try{return L(j,r,function(r){if(r.includes("-----BEGIN PUBLIC KEY-----"))throw new e.TokenError(e.TokenError.codes.invalidKey,"Public keys are not supported for signing.");const t=r.trim().match(x);if(!t)return"HS256";let n,i,o;switch(t[1]){case"RSA":return"RS256";case"EC":n=B.decode(r,"pem",{label:"EC PRIVATE KEY"}),o=n.parameters.value.join(".");break;default:switch(n=C.decode(r,"pem",{label:"PRIVATE KEY"}),i=n.algorithm.algorithm.join("."),i){case"1.2.840.113549.1.1.1":return"RS256";case"1.2.840.10045.2.1":o=n.algorithm.parameters.join(".");break;case"1.3.101.112":case"1.3.101.113":return"EdDSA";default:throw new e.TokenError(e.TokenError.codes.invalidKey,`Unsupported PEM PCKS8 private key with OID ${i}.`)}}const a=V[o];if(!a)throw new e.TokenError(e.TokenError.codes.invalidKey,`Unsupported EC private key with curve ${o}.`);return"ES"+a.bits}(r))}catch(t){throw L(j,r,null,e.TokenError.wrap(t,e.TokenError.codes.invalidKey,"Unsupported PEM private key."))}},exports.detectPublicKeyAlgorithms=function(r){if(!r)return"none";const[t,n]=I.get(r)||[];if(t)return t;if(n)throw n;try{if(r instanceof Buffer)r=r.toString("utf-8");else if("string"!=typeof r)throw new e.TokenError(e.TokenError.codes.invalidKey,"The public key must be a string or a buffer.");return L(I,r,function(r){if(r.match(x))throw new e.TokenError(e.TokenError.codes.invalidKey,"Private keys are not supported for verifying.");if(!r.includes("-----BEGIN PUBLIC KEY-----"))return U;const t=_.decode(r,"pem",{label:"PUBLIC KEY"}),n=t.algorithm.algorithm.join(".");let i;switch(n){case"1.2.840.113549.1.1.1":return R;case"1.2.840.10045.2.1":i=t.algorithm.parameters.join(".");break;case"1.3.101.112":case"1.3.101.113":return["EdDSA"];default:throw new e.TokenError(e.TokenError.codes.invalidKey,`Unsupported PEM PCKS8 public key with OID ${n}.`)}const o=V[i];if(!o)throw new e.TokenError(e.TokenError.codes.invalidKey,`Unsupported EC public key with curve ${i}.`);return["ES"+o.bits]}(r))}catch(t){throw L(I,r,null,e.TokenError.wrap(t,e.TokenError.codes.invalidKey,"Unsupported PEM public key."))}},exports.edAlgorithms=["EdDSA"],exports.esAlgorithms=["ES256","ES384","ES512"],exports.hsAlgorithms=U,exports.lruCache=w,exports.rsaAlgorithms=R,exports.useNewCrypto=T,exports.verifySignature=function(n,i,o,a){try{const s=n.slice(0,2),u="SHA"+n.slice(2);if(a=Buffer.from(a,"base64"),"HS"===s)try{return r.timingSafeEqual(r.createHmac(u,i).update(o).digest(),a)}catch(e){return!1}else if("Ed"===s){if("function"==typeof k)return k(void 0,Buffer.from(o,"utf-8"),i,a);throw new e.TokenError(e.TokenError.codes.signError,"EdDSA algorithms are not supported by your Node.js version.")}const h={key:i,padding:E,saltLength:S};return"PS"===s?(h.padding=v,h.saltLength=m):"ES"===s&&(a=t.joseToDer(a,n)),r.createVerify("RSA-"+u).update(o).verify(h,a)}catch(r){throw new e.TokenError(e.TokenError.codes.verifyError,"Cannot verify the signature.",{originalError:r})}};
