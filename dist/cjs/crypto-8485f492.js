var e=require("crypto"),r=require("ecdsa-sig-formatter"),t=require("./error.js");function n(e){Object.defineProperty(this,"_next",{writable:!1,enumerable:!1,value:e}),this.done=!1}n.prototype.next=function(){if(this.done)return{done:!0};var e=this._next();return e.done&&(this.done=!0),e},"undefined"!=typeof Symbol&&(n.prototype[Symbol.iterator]=function(){return this}),n.of=function(){var e=arguments,r=e.length,t=0;return new n((function(){return t>=r?{done:!0}:{done:!1,value:e[t++]}}))},n.empty=function(){var e=new n(null);return e.done=!0,e},n.is=function(e){return e instanceof n||"object"==typeof e&&null!==e&&"function"==typeof e.next};var i=n,o="undefined"!=typeof ArrayBuffer,a="undefined"!=typeof Symbol;function s(e,r){var t,n,i,s,u;if(!e)throw new Error("obliterator/forEach: invalid iterable.");if("function"!=typeof r)throw new Error("obliterator/forEach: expecting a callback.");if(Array.isArray(e)||o&&ArrayBuffer.isView(e)||"string"==typeof e||"[object Arguments]"===e.toString())for(i=0,s=e.length;i<s;i++)r(e[i],i);else if("function"!=typeof e.forEach)if(a&&Symbol.iterator in e&&"function"!=typeof e.next&&(e=e[Symbol.iterator]()),"function"!=typeof e.next)for(n in e)e.hasOwnProperty(n)&&r(e[n],n);else for(t=e,i=0;!0!==(u=t.next()).done;)r(u.value,i),i++;else e.forEach(r)}s.forEachWithNullKeys=function(e,r){var t,n,i,s,u;if(!e)throw new Error("obliterator/forEachWithNullKeys: invalid iterable.");if("function"!=typeof r)throw new Error("obliterator/forEachWithNullKeys: expecting a callback.");if(Array.isArray(e)||o&&ArrayBuffer.isView(e)||"string"==typeof e||"[object Arguments]"===e.toString())for(i=0,s=e.length;i<s;i++)r(e[i],null);else if(e instanceof Set)e.forEach((function(e){r(e,null)}));else if("function"!=typeof e.forEach)if(a&&Symbol.iterator in e&&"function"!=typeof e.next&&(e=e[Symbol.iterator]()),"function"!=typeof e.next)for(n in e)e.hasOwnProperty(n)&&r(e[n],n);else for(t=e,i=0;!0!==(u=t.next()).done;)r(u.value,null),i++;else e.forEach(r)};var u=s,h={};!function(e){var r=Math.pow(2,8)-1,t=Math.pow(2,16)-1,n=Math.pow(2,32)-1,i=Math.pow(2,7)-1,o=Math.pow(2,15)-1,a=Math.pow(2,31)-1;e.getPointerArray=function(e){var i=e-1;return i<=r?Uint8Array:i<=t?Uint16Array:i<=n?Uint32Array:Float64Array},e.getSignedPointerArray=function(e){var r=e-1;return r<=i?Int8Array:r<=o?Int16Array:r<=a?Int32Array:Float64Array},e.getNumberType=function(e){return e===(0|e)?-1===Math.sign(e)?e<=127&&e>=-128?Int8Array:e<=32767&&e>=-32768?Int16Array:Int32Array:e<=255?Uint8Array:e<=65535?Uint16Array:Uint32Array:Float64Array};var s={Uint8Array:1,Int8Array:2,Uint16Array:3,Int16Array:4,Uint32Array:5,Int32Array:6,Float32Array:7,Float64Array:8};e.getMinimalRepresentation=function(r,t){var n,i,o,a,u,h=null,f=0;for(a=0,u=r.length;a<u;a++)o=t?t(r[a]):r[a],i=e.getNumberType(o),(n=s[i.name])>f&&(f=n,h=i);return h},e.isTypedArray=function(e){return"undefined"!=typeof ArrayBuffer&&ArrayBuffer.isView(e)},e.concat=function(){var e,r,t,n=0;for(e=0,t=arguments.length;e<t;e++)n+=arguments[e].length;var i=new arguments[0].constructor(n);for(e=0,r=0;e<t;e++)i.set(arguments[e],r),r+=arguments[e].length;return i},e.indices=function(r){for(var t=new(e.getPointerArray(r))(r),n=0;n<r;n++)t[n]=n;return t}}(h);var f={},c=u,l=h;function y(e){return"number"==typeof e.length?e.length:"number"==typeof e.size?e.size:void 0}f.isArrayLike=function(e){return Array.isArray(e)||l.isTypedArray(e)},f.guessLength=y,f.toArray=function(e){var r=y(e),t="number"==typeof r?new Array(r):[],n=0;return c(e,(function(e){t[n++]=e})),t},f.toArrayWithIndices=function(e){var r=y(e),t="number"==typeof r?l.getPointerArray(r):Array,n="number"==typeof r?new Array(r):[],i="number"==typeof r?new t(r):[],o=0;return c(e,(function(e){n[o]=e,i[o]=o++})),[n,i]};var p=i,d=u,w=h,v=f;function g(e,r,t){if(arguments.length<2&&(t=e,e=null,r=null),this.capacity=t,"number"!=typeof this.capacity||this.capacity<=0)throw new Error("mnemonist/lru-cache: capacity should be positive number.");var n=w.getPointerArray(t);this.forward=new n(t),this.backward=new n(t),this.K="function"==typeof e?new e(t):new Array(t),this.V="function"==typeof r?new r(t):new Array(t),this.size=0,this.head=0,this.tail=0,this.items={}}g.prototype.clear=function(){this.size=0,this.head=0,this.tail=0,this.items={}},g.prototype.splayOnTop=function(e){var r=this.head;if(this.head===e)return this;var t=this.backward[e],n=this.forward[e];return this.tail===e?this.tail=t:this.backward[n]=t,this.forward[t]=n,this.backward[r]=e,this.head=e,this.forward[e]=r,this},g.prototype.set=function(e,r){var t=this.items[e];if(void 0!==t)return this.splayOnTop(t),void(this.V[t]=r);this.size<this.capacity?t=this.size++:(t=this.tail,this.tail=this.backward[t],delete this.items[this.K[t]]),this.items[e]=t,this.K[t]=e,this.V[t]=r,this.forward[t]=this.head,this.backward[this.head]=t,this.head=t},g.prototype.setpop=function(e,r){var t=null,n=null,i=this.items[e];return void 0!==i?(this.splayOnTop(i),t=this.V[i],this.V[i]=r,{evicted:!1,key:e,value:t}):(this.size<this.capacity?i=this.size++:(i=this.tail,this.tail=this.backward[i],t=this.V[i],n=this.K[i],delete this.items[this.K[i]]),this.items[e]=i,this.K[i]=e,this.V[i]=r,this.forward[i]=this.head,this.backward[this.head]=i,this.head=i,n?{evicted:!0,key:n,value:t}:null)},g.prototype.has=function(e){return e in this.items},g.prototype.get=function(e){var r=this.items[e];if(void 0!==r)return this.splayOnTop(r),this.V[r]},g.prototype.peek=function(e){var r=this.items[e];if(void 0!==r)return this.V[r]},g.prototype.forEach=function(e,r){r=arguments.length>1?r:this;for(var t=0,n=this.size,i=this.head,o=this.K,a=this.V,s=this.forward;t<n;)e.call(r,a[i],o[i],this),i=s[i],t++},g.prototype.keys=function(){var e=0,r=this.size,t=this.head,n=this.K,i=this.forward;return new p((function(){if(e>=r)return{done:!0};var o=n[t];return++e<r&&(t=i[t]),{done:!1,value:o}}))},g.prototype.values=function(){var e=0,r=this.size,t=this.head,n=this.V,i=this.forward;return new p((function(){if(e>=r)return{done:!0};var o=n[t];return++e<r&&(t=i[t]),{done:!1,value:o}}))},g.prototype.entries=function(){var e=0,r=this.size,t=this.head,n=this.K,i=this.V,o=this.forward;return new p((function(){if(e>=r)return{done:!0};var a=n[t],s=i[t];return++e<r&&(t=o[t]),{done:!1,value:[a,s]}}))},"undefined"!=typeof Symbol&&(g.prototype[Symbol.iterator]=g.prototype.entries),g.prototype.inspect=function(){for(var e,r=new Map,t=this.entries();!(e=t.next()).done;)r.set(e.value[0],e.value[1]);return Object.defineProperty(r,"constructor",{value:g,enumerable:!1}),r},"undefined"!=typeof Symbol&&(g.prototype[Symbol.for("nodejs.util.inspect.custom")]=g.prototype.inspect),g.from=function(e,r,t,n){if(arguments.length<2){if("number"!=typeof(n=v.guessLength(e)))throw new Error("mnemonist/lru-cache.from: could not guess iterable length. Please provide desired capacity as last argument.")}else 2===arguments.length&&(n=r,r=null,t=null);var i=new g(r,t,n);return d(e,(function(e,r){i.set(r,e)})),i};var m=g;const b=require("asn1.js").define,{RSA_PKCS1_PSS_PADDING:E,RSA_PSS_SALTLEN_DIGEST:A,RSA_PKCS1_PADDING:S,RSA_PSS_SALTLEN_MAX_SIGN:k,RSA_PSS_SALTLEN_AUTO:T}=e.constants;let P=e.sign;const K=e.verify,j="function"==typeof P,x=/[=+/]/g,I={"=":"","+":"-","/":"_"},U=/^-----BEGIN(?: (RSA|EC))? PRIVATE KEY-----/,R=new m(1e3),V=new m(1e3),C=["HS256","HS384","HS512"],_=["RS256","RS384","RS512","PS256","PS384","PS512"],B={"1.2.840.10045.3.1.7":{bits:"256",names:["P-256","prime256v1"]},"1.3.132.0.10":{bits:"256",names:["secp256k1"]},"1.3.132.0.34":{bits:"384",names:["P-384","secp384r1"]},"1.3.132.0.35":{bits:"512",names:["P-521","secp521r1"]}};j||(P=function(r,n,i){if(void 0===r)throw new t.TokenError(t.TokenError.codes.signError,"EdDSA algorithms are not supported by your Node.js version.");return e.createSign(r).update(n).sign(i)});const N=b("PrivateKey",(function(){this.seq().obj(this.key("version").int(),this.key("algorithm").seq().obj(this.key("algorithm").objid(),this.key("parameters").optional().objid()))})),L=b("PublicKey",(function(){this.seq().obj(this.key("algorithm").seq().obj(this.key("algorithm").objid(),this.key("parameters").optional().objid()))})),M=b("ECPrivateKey",(function(){this.seq().obj(this.key("version").int(),this.key("privateKey").octstr(),this.key("parameters").explicit(0).optional().choice({namedCurve:this.objid()}))}));function D(e){return I[e]}function z(e,r,t,n){return e.set(r,[t,n]),t||n}exports.base64UrlMatcher=x,exports.base64UrlReplacer=D,exports.createSignature=function(n,i,o){try{const t=n.slice(0,2),a=`sha${n.slice(2)}`;let s,u;switch(t){case"HS":s=e.createHmac(a,i).update(o).digest("base64");break;case"ES":s=r.derToJose(P(a,Buffer.from(o,"utf-8"),i),n).toString("base64");break;case"RS":case"PS":u={key:i,padding:S,saltLength:k},"PS"===t&&(u.padding=E,u.saltLength=A),s=e.createSign(a).update(o).sign(u).toString("base64");break;case"Ed":s=P(void 0,Buffer.from(o,"utf-8"),i).toString("base64")}return s.replace(x,D)}catch(e){throw new t.TokenError(t.TokenError.codes.signError,"Cannot create the signature.",{originalError:e})}},exports.detectPrivateKeyAlgorithm=function(e){if(e instanceof Buffer)e=e.toString("utf-8");else if("string"!=typeof e)throw new t.TokenError(t.TokenError.codes.invalidKey,"The private key must be a string or a buffer.");const[r,n]=R.get(e)||[];if(r)return r;if(n)throw n;try{return z(R,e,function(e){if(e.includes("-----BEGIN PUBLIC KEY-----"))throw new t.TokenError(t.TokenError.codes.invalidKey,"Public keys are not supported for signing.");const r=e.trim().match(U);if(!r)return"HS256";let n,i,o;switch(r[1]){case"RSA":return"RS256";case"EC":n=M.decode(e,"pem",{label:"EC PRIVATE KEY"}),o=n.parameters.value.join(".");break;default:switch(n=N.decode(e,"pem",{label:"PRIVATE KEY"}),i=n.algorithm.algorithm.join("."),i){case"1.2.840.113549.1.1.1":return"RS256";case"1.2.840.10045.2.1":o=n.algorithm.parameters.join(".");break;case"1.3.101.112":case"1.3.101.113":return"EdDSA";default:throw new t.TokenError(t.TokenError.codes.invalidKey,`Unsupported PEM PCKS8 private key with OID ${i}.`)}}const a=B[o];if(!a)throw new t.TokenError(t.TokenError.codes.invalidKey,`Unsupported EC private key with curve ${o}.`);return`ES${a.bits}`}(e))}catch(r){throw z(R,e,null,t.TokenError.wrap(r,t.TokenError.codes.invalidKey,"Unsupported PEM private key."))}},exports.detectPublicKeyAlgorithms=function(e){if(!e)return"none";const[r,n]=V.get(e)||[];if(r)return r;if(n)throw n;try{if(e instanceof Buffer)e=e.toString("utf-8");else if("string"!=typeof e)throw new t.TokenError(t.TokenError.codes.invalidKey,"The public key must be a string or a buffer.");return z(V,e,function(e){if(e.match(U))throw new t.TokenError(t.TokenError.codes.invalidKey,"Private keys are not supported for verifying.");if(!e.includes("-----BEGIN PUBLIC KEY-----"))return C;const r=L.decode(e,"pem",{label:"PUBLIC KEY"}),n=r.algorithm.algorithm.join(".");let i;switch(n){case"1.2.840.113549.1.1.1":return _;case"1.2.840.10045.2.1":i=r.algorithm.parameters.join(".");break;case"1.3.101.112":case"1.3.101.113":return["EdDSA"];default:throw new t.TokenError(t.TokenError.codes.invalidKey,`Unsupported PEM PCKS8 public key with OID ${n}.`)}const o=B[i];if(!o)throw new t.TokenError(t.TokenError.codes.invalidKey,`Unsupported EC public key with curve ${i}.`);return[`ES${o.bits}`]}(e))}catch(r){throw z(V,e,null,t.TokenError.wrap(r,t.TokenError.codes.invalidKey,"Unsupported PEM public key."))}},exports.edAlgorithms=["EdDSA"],exports.esAlgorithms=["ES256","ES384","ES512"],exports.hsAlgorithms=C,exports.lruCache=m,exports.rsaAlgorithms=_,exports.useNewCrypto=j,exports.verifySignature=function(n,i,o,a){try{const s=n.slice(0,2),u=`SHA${n.slice(2)}`;if(a=Buffer.from(a,"base64"),"HS"===s)try{return e.timingSafeEqual(e.createHmac(u,i).update(o).digest(),a)}catch(e){return!1}else if("Ed"===s){if("function"==typeof K)return K(void 0,Buffer.from(o,"utf-8"),i,a);throw new t.TokenError(t.TokenError.codes.signError,"EdDSA algorithms are not supported by your Node.js version.")}const h={key:i,padding:S,saltLength:T};return"PS"===s?(h.padding=E,h.saltLength=A):"ES"===s&&(a=r.joseToDer(a,n)),e.createVerify("RSA-"+u).update(o).verify(h,a)}catch(e){throw new t.TokenError(t.TokenError.codes.verifyError,"Cannot verify the signature.",{originalError:e})}};
